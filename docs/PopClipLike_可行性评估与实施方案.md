---
title: PopClip-like（自用版）可行性评估与实施方案
author: henery + CodeBuddy-GPT5.2
updated: 2026-01-29
scope: macOS 本地自用
---

### 0. 背景与目标
你希望开发一款 **macOS 本地自用** 的 PopClip-like 小工具：常驻后台进程（Agent，无主窗口，可选菜单栏入口）；当用户发生“文本选中”交互时在选区附近弹出动作条；MVP 仅需 **复制**（写入剪贴板）、**搜索**（可配置搜索引擎，Chrome 打开）、**Bob**（通过 Bob 官方 AppleScript/JXA 接口唤起翻译界面）。

- **明确不做（MVP）**：OCR/截图扩展、插件商店、复杂跨设备同步、云端账号体系。
- **后期扩展**：在动作条中接入 `localRagHub`（快捷键调用）、本地 Ollama/云模型动作、个人知识库联动。

---

### 1. 结论（可行性、难度与建议）
- **可行性**：高（自用、范围可控、功能聚焦）。
- **技术难度与复杂度**：整体 **B+ 到 A-**（取决于“选区获取/触发判定”的稳定性目标）；你要求“最好 A+”，可以通过 **分阶段 + 退化策略 + 少量适配规则** 逐步逼近。
- **关键现实约束**：macOS 并没有一个在所有 App 中都稳定返回“选中文本 + 选区矩形”的统一 API，必须接受“部分 App 场景降级”并用策略兜底。

**建议路径**：先把 MVP 打通（复制/搜索/Bob + 可靠触发 + 非抢焦点 UI），再根据你的高优先级 App（Chrome、VSCode、微信等）逐个补齐稳定性。

---

### 2. 需求澄清（已按你的补充更新）
#### 2.1 MVP 功能（第一阶段必须完成）
- **触发**：发生文本选中交互 → 弹出动作条（可配置最小字符数/延时，默认尽量“即时”）。
- **动作条按钮**：
  - **复制**：将选中文本写入系统剪贴板（不需要回填替换）。
  - **搜索**：使用可配置搜索引擎（默认 Google/必应/百度可选），在 **Chrome** 打开搜索结果页。
  - **Bob**：唤起 Bob 界面并发起翻译（优先“直接翻译文本”，可降级为“划词翻译/显示窗口”）。
- **常驻与设置**：
  - 后台常驻进程（Agent），可选菜单栏入口；支持开机启动。
  - 配置 UI：搜索引擎、动作按钮显示/排序、触发延迟/阈值、禁用 App 列表（黑名单）。

#### 2.2 目标 App（优先级从高到低）
- **Chrome（必须）**
- **IDE/编辑器（重点 VSCode）**
- **文档阅读器（如印象笔记客户端等）**
- **微信 / 企微（聊天输入框与消息区域）**

---

### 3. 关键技术点拆解（决定“顺滑稳定”的地方）
#### 3.1 选中文本获取（Selection）
按可靠性与覆盖面建议采用“多策略降级”，并为每一次获取加超时（例如 150–300ms），避免常驻进程卡顿。

- **策略 S1：Accessibility（AX）直取（首选）**
  - 获取系统级焦点元素（focused UI element），读取 `kAXSelectedTextAttribute`。
  - 同时尝试 `kAXSelectedTextRangeAttribute` + `kAXBoundsForRangeParameterizedAttribute` 获取选区矩形，用于动作条定位。
  - 优点：体验最佳，不破坏剪贴板；缺点：不同 App/控件实现差异大。

- **策略 S2：AX + 鼠标位置推断（次选）**
  - 如果拿不到选区矩形，但拿得到选中文本，则动作条定位到鼠标附近（或光标附近）。

- **策略 S3：模拟复制 + 读剪贴板（兜底）**
  - 在无法通过 AX 获取选区文本时：
    - 先快照当前剪贴板（至少保存字符串）；
    - 发送 Cmd+C（可能需要 Input Monitoring/辅助功能相关权限）；
    - 读取剪贴板文本；
    - 还原剪贴板。
  - 这是覆盖面最强的兜底，但要非常谨慎：避免影响用户原剪贴板、避免在密码框/敏感控件触发。

#### 3.2 触发判定（Trigger）
你要求“只要发生文本选中交互就触发”。落地时建议采用“组合触发”，以减少漏触与误触：

- **主触发**：监听选区变化（AX 通知，例如 selected text changed / value changed）
- **辅触发**：全局鼠标抬起（mouse up）后短延迟（如 30–60ms）抓取一次选区
- **去抖/防抖**：同一选区文本短时间重复变化时合并（避免拖选过程中闪烁）
- **最小阈值**：默认 `>= 1` 字符（你想“任何选中都触发”），但保留可配置以便你后期减少误触。

#### 3.3 动作条 UI（Overlay）
- 使用 **非抢焦点** 的浮层（常见实现为 `NSPanel` / borderless window + non-activating 行为）。
- 始终避免抢走键盘焦点；点击按钮只执行动作并自动隐藏。
- 定位规则：优先选区矩形；否则鼠标附近；并处理屏幕边缘避让。
- 低延迟：UI 创建要复用（窗口常驻、内容更新），避免每次选中都新建窗口。

---

### 4. Bob 集成方案（基于官方 AppleScript/JXA 文档）
Bob 官方提供统一的 `request(JSON)` 接口（AppleScript / JXA 都可调用），核心结构：

- `path`: 固定为 `"translate"`
- `body.action` 常用值：
  - `"translateText"`：**直接翻译文本**（需传 `body.text`）
  - `"selectionTranslate"`：让 Bob 执行“划词翻译”动作
  - `"showWindow"`：仅显示窗口

重要说明（来自文档要点）：
- 该 `request` 接口通常是“发起请求并由 Bob 界面展示结果”，**不会把翻译结果返回给脚本**。
- 源/目标语言主要由 Bob 应用内设置决定；接口不强调在 JSON 中显式指定。

**推荐调用优先级（从体验最好到最稳）**：
1. `translateText`（把我们抓取到的选中文本直接交给 Bob，最丝滑且不依赖 Bob 自己再次取选区）
2. `selectionTranslate`（如果我们抓取文本失败，可退化为让 Bob 自己做“划词翻译”）
3. `showWindow`（最保底：至少能唤起 Bob）

---

### 5. 浏览器搜索（Chrome 必须）
MVP 最稳的实现是：构造搜索 URL（例如 `https://www.google.com/search?q=...`）并打开。

- **方案 A（推荐 MVP）**：使用系统打开 URL（简单、稳、成本低）
  - 若你把 Chrome 设为默认浏览器，则体验与“指定 Chrome 打开”几乎等价。
- **方案 B（增强）**：通过脚本让 Chrome 在新标签打开（更可控，但依赖自动化权限与脚本稳定性）

建议先做 **方案 A**，把可靠性与复杂度控制住；后续再加“总是在 Chrome 新标签打开”的选项。

---

### 6. 权限、限制因素与风险对策（自用也要考虑）
#### 6.1 可能需要的权限
- **Accessibility（辅助功能）**：读取选区、获取 focused element、获取范围矩形（核心）。
- **Apple Events（自动化控制）**：调用 Bob、（可选）控制 Chrome。
- **Input Monitoring（输入监控）**：若采用全局事件监听或模拟 Cmd+C 兜底。
- **LSUIElement（Agent 模式）**：隐藏 Dock 与主窗口形态，保持后台运行体验一致。

#### 6.2 风险点与对策
- **AX 在不同 App 行为不一致**：多策略降级（AX → 鼠标定位 → 复制兜底），并对高优先级 App 做少量适配。
- **误触/闪烁**：拖选时连续变化 → 去抖 + 鼠标松开后展示；空选区/短文本不展示（可配置）。
- **剪贴板污染**：兜底复制策略必须“快照与还原”，并对敏感控件禁用。
- **性能**：事件合并、超时、后台队列；UI 复用；减少 AX 树遍历。

---

### 7. 技术选型（适配“顺滑稳定”诉求）
- **主语言/框架**：Swift + AppKit（设置界面可用 SwiftUI）
- **模块划分**：
  - `SelectionService`：AX 获取选区（含退化策略）
  - `TriggerService`：事件监听与触发判定
  - `OverlayController`：动作条 UI（非抢焦点）
  - `ActionEngine`：复制/搜索/Bob 三个动作
  - `Settings`：偏好设置、开机启动、App 黑名单
  - `Diagnostics`：日志与诊断导出（后期适配的关键）

---

### 8. 具体实施方案（里程碑与交付物）
#### Milestone 0（工程改造：可运行的后台骨架）
**目标**：把工程改造成 Agent 形态，拥有一个最小浮窗（可手动触发显示）。
- 应用形态：无主窗口、隐藏 Dock（LSUIElement=1），启动后常驻。
- 浮窗：非抢焦点 NSPanel，能在鼠标附近显示。
- 动作：先用占位文本验证复制/搜索/Bob 触发链路。

#### Milestone 1（MVP 打通：可用）
**目标**：在 Chrome/VSCode 等主场景能弹出动作条并完成 3 个动作。
- 选区获取：AX 直取 + 鼠标定位；兜底复制策略先关闭或仅对少数 App 开启。
- 动作条：固定 3 个按钮（复制/搜索/Bob），支持键鼠点击。
- Bob：优先 `translateText`。
- 设置：最小化（搜索引擎配置、开机启动开关、禁用 App 列表）。

**验收标准**：
- Chrome、VSCode 中拖选文本松开鼠标后动作条出现；
- 点击“复制”后剪贴板内容为选中文本；
- 点击“搜索”能打开搜索结果页；
- 点击“Bob”唤起 Bob 并展示翻译。

#### Milestone 2（稳定性增强：覆盖你的目标 App）
- 引入“组合触发”（AX 通知 + mouse up 抓取）。
- 引入兜底复制策略（可按 App 开关）。
- 增加“最小字符数/延时/禁止在输入框弹出”等策略项。
- 针对微信/企微/文档类 App 做定向适配与黑名单策略。

#### Milestone 3（可扩展：为 localRagHub/AI 动作铺路）
- 抽象 Action 协议（内置动作 + 可插拔动作）。
- 增加“通过快捷键触发 action”（为 `localRagHub` 接入做准备）。
- 预留：把选中文本送入本地 Ollama / 云 API 的动作。

---

### 9. 成本与周期（按“自用 + MVP 优先”估算）
以你已有 macOS 客户端经验为前提：
- **Milestone 1**：约 1–3 周（业余 2–6 周）
- **Milestone 2**：约 2–6 周（取决于微信/企微/文档类 App 的选区获取难度与退化策略）
- **Milestone 3**：约 1–3 周（主要是架构抽象与快捷键/动作扩展）

---

### 10. 建议的工程结构（便于长期维护与适配）
- `App/`：生命周期、Agent 形态、可选菜单栏入口
- `Core/Selection/`：AX 获取与退化策略
- `Core/Trigger/`：事件监听、去抖、策略
- `UI/Overlay/`：动作条窗口与布局
- `Actions/`：Copy/Search/Bob/（future: localRagHub/Ollama）
- `Settings/`：偏好设置、开机启动、App 列表
- `Diagnostics/`：日志与诊断导出

---

### 11. 建议你开工时的第一件事
先以 Chrome + VSCode 为验收对象，把 **AX 取选区 + 非抢焦点动作条 + 复制/搜索/Bob** 跑通；同时把“诊断日志”做出来（哪怕只是本地文件日志），后续所有适配都会因此快很多。

---

### 附录 A：Bob 官方脚本接口速记（文档要点）
- 统一调用：向 Bob 发送 `request(JSON.stringify({ path: "translate", body: { action: "translateText", text: "..." } }))`
- 常用 action：`translateText` / `selectionTranslate` / `showWindow` / `pasteboardTranslate`
- `request` 模式通常不返回翻译文本（由 Bob 界面展示）。

---

### 12. PRD 细化补充（信息架构 / 设置项默认值 / 交互细节 / 验收用例）
本章节目的是把前述方案落到“你可以直接照着做”的规格层面，避免实现时来回纠结默认行为。

#### 12.1 信息架构（UI 组成）
- **菜单栏图标（可选）**
  - **主菜单项**：
    - **启用/暂停**（Toggle）
    - **偏好设置…**
    - **诊断与日志…**（打开日志目录 / 导出诊断包）
    - **关于 / 退出**
- **动作条（Overlay，必有）**
  - 默认 3 个按钮：**复制 / 搜索 / Bob**
  - 可选：一个“更多/设置”入口（MVP 可不做）
- **偏好设置窗口（必有）**
  - 推荐用侧边栏或 Tab：`通用` / `动作条` / `搜索` / `集成` / `应用规则` / `高级`

#### 12.2 设置项清单（含建议默认值）
- **通用（General）**
  - **启用本工具**：默认开
  - **开机启动**：默认关
  - **显示菜单栏图标**：默认开（可不提供关闭）
  - **权限向导入口**：显示当前授权状态（Accessibility / Automation / Input Monitoring）并提供“去设置”按钮

- **触发（Trigger）**
  - **触发方式**：默认 `鼠标松开后触发`（减少拖选中闪烁）；高级可加 `选区变化即触发`
  - **触发延时**：默认 50ms（范围建议 0–300ms，可拖动）
  - **最小字符数**：默认 1（你想“任何选中都触发”）
  - **最大字符数**：默认 20000（超长也允许，但防止极端卡顿；超出时提示并允许继续）
  - **敏感控件禁用**：默认开（检测到密码输入框/secure text field 直接不弹）

- **动作条（Overlay）**
  - **显示位置**：默认 `优先选区矩形，否则鼠标附近`
  - **屏幕边缘避让**：默认开
  - **主题**：默认 `跟随系统深浅色`
  - **自动隐藏**：默认 `执行动作后隐藏` + `点击外部区域隐藏`
  - **键盘行为**：默认 `Esc 隐藏`（MVP 可先不做复杂快捷键导航）

- **搜索（Search）**
  - **搜索引擎**：默认 Google（可选：必应/百度/自定义）
  - **自定义搜索 URL 模板**：默认空；格式示例：`https://www.google.com/search?q={query}`
  - **打开方式**：默认 `系统打开 URL`（稳定优先）；可选 `总在 Chrome 打开`（需要额外自动化/脚本）

- **集成（Integrations）**
  - **Bob 调用模式**：默认 `translateText`（把选中文本直接传给 Bob）
  - **Bob 失败降级**：默认开：`translateText` 失败 → `selectionTranslate` → `showWindow`

- **应用规则（App Rules）**
  - **禁用 App 列表（黑名单）**：默认空
  - **只在白名单 App 启用（高级）**：默认关
  - **对某些 App 强制启用剪贴板兜底（高级）**：默认关（后期用来提升微信/企微/文档类覆盖）

- **高级（Advanced）**
  - **启用剪贴板兜底（S3）**：默认关（先保证“无侵入”，后期按需开启）
  - **诊断日志级别**：默认 `info`（可选 debug）
  - **导出诊断包**：包含：配置、最近日志、App 列表、权限状态快照（注意脱敏）

#### 12.3 关键交互细节（你会最在意的“像 PopClip 一样顺滑”）
- **弹出时机**
  - 推荐默认：用户完成一次选择动作（mouse up）后再弹出；拖选过程中不频繁移动/闪烁。
- **不抢焦点**
  - 动作条出现不改变当前焦点窗口；你继续输入不会被打断。
- **按钮点击反馈**
  - 点击后立即执行动作（复制/打开 URL/唤起 Bob），并在 0–200ms 内隐藏动作条。
- **重复选择**
  - 若选区文本未变化且动作条已显示：不重建窗口，只做位置微调（提升流畅度）。
- **失败提示策略（MVP）**
  - 复制失败/未获取到选区：动作条显示“未获取到文本”（1 秒后自动消失）。
  - Bob 未安装/无权限：提示一次，并在设置页给出“去授权/去安装”入口。

#### 12.4 自测/验收用例表（建议直接作为 Milestone 1/2 验收清单）
- **核心链路（必须通过）**
  - **用例 1（Chrome 选中文本 → 动作条出现）**：拖选一段文字松开鼠标，动作条在选区附近出现，且不抢焦点。
  - **用例 2（复制）**：点击“复制”，剪贴板内容与选中文本一致；动作条自动隐藏。
  - **用例 3（搜索）**：点击“搜索”，打开搜索结果页，`{query}` 编码正确（包含空格/中文）。
  - **用例 4（Bob translateText）**：点击“Bob”，Bob 窗口弹出并展示翻译；动作条隐藏。

- **重点 App 覆盖（优先级验证）**
  - **用例 5（VSCode 编辑区）**：选择代码/中文注释均能弹出；复制可用。
  - **用例 6（微信/企微输入框）**：选择输入框内文本能弹出；若 AX 取不到文本则记录日志（为后续兜底做依据）。
  - **用例 7（文档阅读器）**：选择正文能弹出；位置不越界。

- **边界与稳定性（建议 Milestone 2 前后逐步补齐）**
  - **用例 8（快速多次选择）**：连续选择不同文本 10 次，动作条无明显闪烁/残影/卡顿。
  - **用例 9（多屏幕/不同 DPI）**：副屏/外接屏选择文本，动作条位置正确。
  - **用例 10（边缘避让）**：在屏幕四角附近选中文本，动作条不会跑出屏幕。
  - **用例 11（权限缺失）**：撤销 Accessibility 权限后，应用能检测并提示引导，不会疯狂弹窗或崩溃。
  - **用例 12（敏感控件）**：在密码框/安全输入控件选择（或尝试选择）时不弹出动作条。

---

（如果你希望下一步继续落地到“开发任务拆分 + 目录骨架 + 关键 API 选型清单（AX 具体属性/通知）”，我可以在这个文档后面再追加一个“实现级 checklist”。）
